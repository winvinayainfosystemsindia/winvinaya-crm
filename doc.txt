# Step-by-Step Guide to Create Branches

I'll help you create these branches properly. Here's what we'll do:

1. First, commit or stash your current changes:
# Check what's modified
git status

# Either commit the changes
git add README.md
git commit -m "docs: update README"

# OR stash them temporarily
git stash

2. Create the develop branch from main:
# Make sure you're on main and it's up to date
git checkout main
git pull origin main

# Create develop branch from main
git checkout -b develop
git push -u origin develop

3. Create the qa branch from main:
# Go back to main
git checkout main

# Create qa branch from main
git checkout -b qa
git push -u origin qa

4. Verify all branches are created:
git branch -a

------------------------------------------------

STEP 2: Set Up Your EC2 Instance
2.1 Launch EC2 Instance
OS: Ubuntu 22.04 LTS
Instance Type: t3.medium or larger (recommended)
Security Group: Open ports 22 (SSH), 80 (HTTP), 443 (HTTPS)
Storage: At least 20GB

2.2 Connect to EC2
ssh -i your-key.pem ubuntu@YOUR_EC2_IP

2.3 Install Required Software
# Update system
sudo apt update && sudo apt upgrade -y

# Install Python 3.11
sudo apt install software-properties-common -y
sudo add-apt-repository ppa:deadsnakes/ppa -y
sudo apt update
sudo apt install python3.11 python3.11-venv python3.11-dev -y

# Install Node.js 20
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install nodejs -y

# Install PostgreSQL
sudo apt install postgresql postgresql-contrib -y

# Install Nginx
sudo apt install nginx -y

# Install PM2 globally
sudo npm install -g pm2

# Install Git
sudo apt install git -y

STEP 3: Set Up PostgreSQL Databases
# Switch to postgres user
sudo -u postgres psql

-- 1. Create user
CREATE USER winvinaya_user WITH PASSWORD 'winvinaya12345';

-- 2. Create databases with correct owner
CREATE DATABASE winvinaya_dev OWNER winvinaya_user;
CREATE DATABASE winvinaya_qa OWNER winvinaya_user;
CREATE DATABASE winvinaya_prod OWNER winvinaya_user;

-- 3. Grant all privileges (optional but clean)
GRANT ALL PRIVILEGES ON DATABASE winvinaya_dev TO winvinaya_user;
GRANT ALL PRIVILEGES ON DATABASE winvinaya_qa TO winvinaya_user;
GRANT ALL PRIVILEGES ON DATABASE winvinaya_prod TO winvinaya_user;

-- 4. Ensure privileges on future tables
ALTER DEFAULT PRIVILEGES FOR USER winvinaya_user
    GRANT ALL ON TABLES TO winvinaya_user;

ALTER DEFAULT PRIVILEGES FOR USER winvinaya_user
    GRANT ALL ON SEQUENCES TO winvinaya_user;

\q


STEP 4: Clone Repository on EC2
# Create directory
sudo mkdir -p /var/www
cd /var/www

# Clone your repository
sudo git clone https://github.com/winvinayainfosystemsindia/winvinaya-crm.git
sudo chown -R ubuntu:ubuntu winvinaya-crm
cd winvinaya-crm

STEP 5: Set Up Environment Files

cd /var/www/winvinaya-crm/backend

# Create .env.dev
cp .env.dev.example .env.dev
nano .env.dev
# Update DATABASE_URL, SECRET_KEY, etc.

# Create .env.qa
cp .env.qa.example .env.qa
nano .env.qa
# Update DATABASE_URL, SECRET_KEY, etc.

# Create .env.prod
cp .env.prod.example .env.prod
nano .env.prod
# Update DATABASE_URL, SECRET_KEY, etc.


STEP 6: Set Up Backend for Each Environment

6.1 Development Environment Setup
cd /var/www/winvinaya-crm/backend

# Create virtual environment
python3.11 -m venv venv-dev
source venv-dev/bin/activate

# Install dependencies
pip install --upgrade pip
pip install -r requirements.txt

# Run database migrations
export $(cat .env.dev | xargs)
alembic upgrade head

# Create initial admin user (if needed)
python -c "from app.db.init_db import init_db; init_db()"

# Test the backend
uvicorn app.main:app --env-file .env.dev --host 0.0.0.0 --port 8001
# Press Ctrl+C to stop after verifying it works

6.2 QA Environment Setup
cd /var/www/winvinaya-crm/backend

# Create virtual environment
python3.11 -m venv venv-qa
source venv-qa/bin/activate

# Install dependencies
pip install --upgrade pip
pip install -r requirements.txt

# Run database migrations
export $(cat .env.qa | xargs)
alembic upgrade head

# Create initial admin user
python -c "from app.db.init_db import init_db; init_db()"

# Test the backend
uvicorn app.main:app --env-file .env.qa --host 0.0.0.0 --port 8002
# Press Ctrl+C to stop after verifying it works

6.3 Production Environment Setup
cd /var/www/winvinaya-crm/backend

# Create virtual environment
python3.11 -m venv venv-prod
source venv-prod/bin/activate

# Install dependencies
pip install --upgrade pip
pip install -r requirements.txt

# Run database migrations
export $(cat .env.prod | xargs)
alembic upgrade head

# Create initial admin user
python -c "from app.db.init_db import init_db; init_db()"

# Test the backend
uvicorn app.main:app --env-file .env.prod --host 0.0.0.0 --port 8003
# Press Ctrl+C to stop after verifying it works


STEP 7: Set Up Frontend for Each Environment

7.1 Create Frontend Environment Files
cd /var/www/winvinaya-crm/frontend

# Development environment
cat > .env.dev << 'EOF'
VITE_API_URL=https://dev-api.winvinaya.com
VITE_ENVIRONMENT=development
EOF

# QA environment
cat > .env.qa << 'EOF'
VITE_API_URL=https://qa-api.winvinaya.com
VITE_ENVIRONMENT=qa
EOF

# Production environment
cat > .env.prod << 'EOF'
VITE_API_URL=https://api.winvinaya.com
VITE_ENVIRONMENT=production
EOF

7.2 Build Frontend for Each Environment
cd /var/www/winvinaya-crm/frontend

# Install dependencies
npm install

# Build for Development
npm run build -- --mode dev
mv dist dist-dev

# Build for QA
npm run build -- --mode qa
mv dist dist-qa

# Build for Production
npm run build -- --mode prod
mv dist dist-prod


STEP 8: Configure Nginx for All Environments

8.1 Create Nginx Configuration Files
# Development configuration
sudo nano /etc/nginx/sites-available/winvinaya-dev

# Paste this configuration:
server {
    listen 80;
    server_name dev.winvinaya.com dev-api.winvinaya.com;

    # Frontend (dev.winvinaya.com)
    location / {
        root /var/www/winvinaya-crm/frontend/dist-dev;
        try_files $uri $uri/ /index.html;
    }

    # Backend API (dev-api.winvinaya.com)
    location /api {
        proxy_pass http://127.0.0.1:8001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# QA configuration
sudo nano /etc/nginx/sites-available/winvinaya-qa

# Paste this configuration:
server {
    listen 80;
    server_name qa.winvinaya.com qa-api.winvinaya.com;

    # Frontend (qa.winvinaya.com)
    location / {
        root /var/www/winvinaya-crm/frontend/dist-qa;
        try_files $uri $uri/ /index.html;
    }

    # Backend API (qa-api.winvinaya.com)
    location /api {
        proxy_pass http://127.0.0.1:8002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Production configuration
sudo nano /etc/nginx/sites-available/winvinaya-prod

# Paste this configuration:
server {
    listen 80;
    server_name winvinaya.com api.winvinaya.com;

    # Frontend (winvinaya.com)
    location / {
        root /var/www/winvinaya-crm/frontend/dist-prod;
        try_files $uri $uri/ /index.html;
    }

    # Backend API (api.winvinaya.com)
    location /api {
        proxy_pass http://127.0.0.1:8003;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

8.2 Enable Nginx Sites
# Enable all sites
sudo ln -s /etc/nginx/sites-available/winvinaya-dev /etc/nginx/sites-enabled/
sudo ln -s /etc/nginx/sites-available/winvinaya-qa /etc/nginx/sites-enabled/
sudo ln -s /etc/nginx/sites-available/winvinaya-prod /etc/nginx/sites-enabled/

# Remove default site
sudo rm /etc/nginx/sites-enabled/default

# Test Nginx configuration
sudo nginx -t

# Restart Nginx
sudo systemctl restart nginx


STEP 9: Set Up SSL with Let's Encrypt

# Install Certbot
sudo apt install certbot python3-certbot-nginx -y

# Get SSL certificates for all domains
# Development
sudo certbot --nginx -d dev.winvinaya.com -d dev-api.winvinaya.com

# QA
sudo certbot --nginx -d qa.winvinaya.com -d qa-api.winvinaya.com

# Production
sudo certbot --nginx -d winvinaya.com -d api.winvinaya.com

# Test auto-renewal
sudo certbot renew --dry-run


STEP 10: Set Up PM2 for Backend Process Management

10.1 Create PM2 Ecosystem File
cd /var/www/winvinaya-crm/backend

cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [
    {
      name: 'winvinaya-dev',
      script: 'venv-dev/bin/uvicorn',
      args: 'app.main:app --host 0.0.0.0 --port 8001',
      cwd: '/var/www/winvinaya-crm/backend',
      env: {
        ENV_FILE: '.env.dev'
      },
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '1G',
    },
    {
      name: 'winvinaya-qa',
      script: 'venv-qa/bin/uvicorn',
      args: 'app.main:app --host 0.0.0.0 --port 8002',
      cwd: '/var/www/winvinaya-crm/backend',
      env: {
        ENV_FILE: '.env.qa'
      },
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '1G',
    },
    {
      name: 'winvinaya-prod',
      script: 'venv-prod/bin/uvicorn',
      args: 'app.main:app --host 0.0.0.0 --port 8003',
      cwd: '/var/www/winvinaya-crm/backend',
      env: {
        ENV_FILE: '.env.prod'
      },
      instances: 2,
      autorestart: true,
      watch: false,
      max_memory_restart: '1G',
    }
  ]
};
EOF

10.2 Start All Backend Services
# Start all services
pm2 start ecosystem.config.js

# Save PM2 configuration
pm2 save

# Set PM2 to start on system boot
pm2 startup
# Follow the command it outputs

# Check status
pm2 status

# View logs
pm2 logs winvinaya-dev
pm2 logs winvinaya-qa
pm2 logs winvinaya-prod


STEP 11: Set Up GitHub Actions for CI/CD

11.1 Add GitHub Secrets
Go to your GitHub repository â†’ Settings â†’ Secrets and variables â†’ Actions
Add these secrets:
- EC2_HOST: Your EC2 IP address
- EC2_USER: ubuntu
- EC2_SSH_KEY: Your private SSH key content

11.2 Create GitHub Actions Workflows
Create these files in your repository:

# .github/workflows/deploy-dev.yml
name: Deploy to Development

on:
  push:
    branches: [ develop ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /var/www/winvinaya-crm
            git checkout develop
            git pull origin develop
            
            # Backend
            cd backend
            source venv-dev/bin/activate
            pip install -r requirements.txt
            alembic upgrade head
            
            # Frontend
            cd ../frontend
            npm install
            npm run build -- --mode dev
            rm -rf dist-dev
            mv dist dist-dev
            
            # Restart services
            pm2 restart winvinaya-dev

# .github/workflows/deploy-qa.yml
name: Deploy to QA

on:
  push:
    branches: [ qa ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /var/www/winvinaya-crm
            git checkout qa
            git pull origin qa
            
            # Backend
            cd backend
            source venv-qa/bin/activate
            pip install -r requirements.txt
            alembic upgrade head
            
            # Frontend
            cd ../frontend
            npm install
            npm run build -- --mode qa
            rm -rf dist-qa
            mv dist dist-qa
            
            # Restart services
            pm2 restart winvinaya-qa

# .github/workflows/deploy-prod.yml
name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # Requires manual approval
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /var/www/winvinaya-crm
            git checkout main
            git pull origin main
            
            # Backend
            cd backend
            source venv-prod/bin/activate
            pip install -r requirements.txt
            alembic upgrade head
            
            # Frontend
            cd ../frontend
            npm install
            npm run build -- --mode prod
            rm -rf dist-prod
            mv dist dist-prod
            
            # Restart services
            pm2 restart winvinaya-prod


STEP 12: Verification and Monitoring

12.1 Verify All Services Are Running
# Check PM2 processes
pm2 status

# Check Nginx status
sudo systemctl status nginx

# Check PostgreSQL
sudo systemctl status postgresql

# View application logs
pm2 logs winvinaya-dev --lines 50
pm2 logs winvinaya-qa --lines 50
pm2 logs winvinaya-prod --lines 50

12.2 Test Each Environment
# Development
curl https://dev-api.winvinaya.com/api/health
curl https://dev.winvinaya.com

# QA
curl https://qa-api.winvinaya.com/api/health
curl https://qa.winvinaya.com

# Production
curl https://api.winvinaya.com/api/health
curl https://winvinaya.com

12.3 Set Up Monitoring (Optional but Recommended)
# Install monitoring tools
pm2 install pm2-logrotate

# Configure log rotation
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7

# Monitor system resources
pm2 monit


STEP 13: Database Backup Strategy

13.1 Create Backup Script
sudo nano /usr/local/bin/backup-databases.sh

# Paste this script:
#!/bin/bash
BACKUP_DIR="/var/backups/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# Backup all databases
pg_dump -U winvinaya_user winvinaya_dev > $BACKUP_DIR/winvinaya_dev_$DATE.sql
pg_dump -U winvinaya_user winvinaya_qa > $BACKUP_DIR/winvinaya_qa_$DATE.sql
pg_dump -U winvinaya_user winvinaya_prod > $BACKUP_DIR/winvinaya_prod_$DATE.sql

# Keep only last 7 days of backups
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete

# Make executable
sudo chmod +x /usr/local/bin/backup-databases.sh

13.2 Set Up Cron Job for Daily Backups
# Edit crontab
crontab -e

# Add this line (runs daily at 2 AM)
0 2 * * * /usr/local/bin/backup-databases.sh


STEP 14: Security Hardening

14.1 Configure Firewall
# Enable UFW
sudo ufw enable

# Allow SSH, HTTP, HTTPS
sudo ufw allow 22
sudo ufw allow 80
sudo ufw allow 443

# Check status
sudo ufw status

14.2 Secure PostgreSQL
sudo nano /etc/postgresql/14/main/pg_hba.conf

# Ensure these lines exist:
local   all             postgres                                peer
local   all             all                                     peer
host    all             all             127.0.0.1/32            md5
host    all             all             ::1/128                 md5

# Restart PostgreSQL
sudo systemctl restart postgresql


DEPLOYMENT COMPLETE! ðŸŽ‰

Your WinVinaya CRM is now deployed with:
âœ… 3 separate environments (dev, qa, prod)
âœ… 3 separate databases
âœ… SSL certificates for all domains
âœ… PM2 process management
âœ… Nginx reverse proxy
âœ… GitHub Actions CI/CD
âœ… Automated database backups
âœ… Security hardening

Access your applications:
- Development: https://dev.winvinaya.com
- QA: https://qa.winvinaya.com
- Production: https://winvinaya.com

